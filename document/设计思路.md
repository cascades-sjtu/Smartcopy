# 设计思路
本文档介绍了根据需求分析结果得出的软件设计思路以及每一步对应的程序模块，依次为难点实现，交互实现和用户界面制作。

## 软件实现难点
鉴于软件的主要功能是**智能图片裁剪**，难点自然也是对图像的识别和裁剪定位。该功能的实现对应程序的vertex_detect模块。

### 确定图像处理库
python常见的图像处理工具为pillow和opencv。考虑到进行图像识别需要先进行**边缘检测**，而opencv中已经封装了效果很好的canny算法，高斯平滑，不需要再手动编写检测函数，故采用opencv-python作为图像处理库。

### 设置裁剪边界识别标准
经过图像预处理后，需要**识别出裁剪边界**，才能实现最终的裁剪。常见的裁剪识别中，用到的最多就是**人脸识别和人眼检测**算法。考虑到本场景中并**没有固定的裁剪对象**，故没有采用人脸识别，而是使用较为基础的方法-**设置阈值，将每个色块的rgb二值化**。识别步骤简介如下：

1. 将图片分为若干个正方形色块
2. 计算每个色块的rgb值和图片的rgb值
3. 遍历色块，标记出包含检测边缘和rgb超过阈值的色块
4. 用矩形框包含出所有符合条件的色块，以矩形的顶点作为边界

## 如何实现交互
本软件不是完全的自动化裁剪，需要在裁剪过程中读取用户输入。每次裁剪都需要经过检测-预览-调整-生成图片的四步骤，后三步分别对应preview，modify和crop模块。

### 生成预览
常见的裁剪场景中，用户需要裁剪出指定**形状，比例**的图片。结合自动识别出的边界，最终的裁剪参数规定如下：
* 矩形：固定裁剪中心，以相对长边为基准，按照比例进行裁剪
* 圆形：固定裁剪中心为圆心，以长和宽的平均数为半径
* 注：考虑裁剪超出图片范围的情况，如圆半径超出范围时，改为内接圆
  
根据最终的裁剪边界，生成初次预览图

### 裁剪调整
考虑到没用使用机器学习的算法，该软件智能裁剪的效果不一定能够满足用户需求，从而需要进行后续的调整。用户主要从**位置**和**大小**两个方面进行调整。由于键盘操作较为方便，故采用键盘读取输入，结合界面的信号处理机制，触发修改函数，重新生成预览。

### 完成裁剪
当经过智能裁剪和用户调整后，用户已经通过预览图确定好最终裁剪参数。由用户确认裁剪，并自动跳转到文件夹中下一张图片，也可以由用户手动指定下一张被裁剪的图片。

## 制作良好界面
采用pysimplegui进行界面设计，美观且代码简洁。不用涉及面向对象的编程。
### 界面布局
先进行用户界面的草图设计，设计出界面结构。
![layout](layout.png)

### 信号处理机制
pysimplegui的信号处理为采用死循环不断读取各个控件或外设发出的信号。从而对于每次循环，识别出触发事件，并读取输入内容，调用对应模块。常见的使用场景产生的主要信号序列如下：
1. 点击browse，浏览图片所在文件夹
2. 点击open，显示文件夹中的所有图片
3. 点击对应图片，显示出图片，并进行边缘检测
4. 选择对应的裁剪需求，点击预览，显示预览
5. 从键盘读取输入，进行调整，再次i西安市预览
6. 点击裁剪，保存文件，跳转到下一文件
7. 以上过程中伴随着状态信息栏的更新
